# RedEye IPC Reference (v0.4 - In Progress)
**Version:** 0.4.0 (Covers Configuration System Phase 1.A)
**Last Updated:** May 20, 2025
## 1. Overview

This document specifies the Inter-Process Communication (IPC) protocol used by RedEye. RedEye employs WebSockets for IPC, allowing external 'Agent' applications to receive events captured by RedEye and to send commands to RedEye.

*   **Transport:** WebSockets
*   **Server URL:** `ws://localhost:8765`
*   **Message Format:** JSON

## 2. General Message Structure

### 2.1. Commands from Client (Agent) to RedEye

All commands sent from an Agent to RedEye should follow this JSON structure:

```json
{
  "commandId": "client_generated_unique_id_optional",
  "action": "actionNameAsString",
  "payload": { /* action-specific payload object, optional */ }
}```

*   `commandId` (String, Optional): A unique identifier generated by the client. If provided, RedEye will include it in its response to help the client correlate requests and responses.
*   `action` (String, Required): The specific action RedEye should perform. See "3. IPC Commands" for a list of actions.
*   `payload` (Object, Optional): A JSON object containing parameters specific to the `action`.

### 2.2. Responses from RedEye to Client (Agent)

For commands that elicit a direct response (most configuration commands), RedEye will reply with a JSON message in the following structure:

```json
{
  "commandId": "client_generated_unique_id_if_provided",
  "status": "success" | "error",
  "message": "Optional human-readable message, especially for errors or simple ACKs",
  "data": { /* action-specific response data, present on success for getter commands */ }
}
```

*   `commandId` (String, Optional): Echoes the `commandId` from the request, if provided.
*   `status` (String, Required): Indicates the outcome of the command.
    *   `"success"`: The command was processed successfully.
    *   `"error"`: An error occurred while processing the command.
*   `message` (String, Optional): A human-readable message, often an error description or a success confirmation.
*   `data` (Object | Array | Primitive, Optional): The data payload of the response, typically present when `status` is `"success"` and the command was a getter (e.g., `getConfig`, `getCapabilities`). The structure of `data` depends on the command.

### 2.3. Events Broadcasted from RedEye to Client (Agent)

RedEye broadcasts captured system and application events to all connected WebSocket clients. These events follow the `RedEyeEvent` structure:

```json
{
  "id": "uuid_string",
  "timestamp": "iso_8601_date_string",
  "eventType": "eventTypeAsString",
  "sourceApplicationName": "string_or_null",
  "sourceBundleIdentifier": "string_or_null",
  "contextText": "string_or_null",
  "metadata": { /* dictionary_of_string_to_string, or_null */ }
}
```
*Refer to `RedEyeEvent.swift` and the "4. Event Types & Payloads" section for details on each `eventType` and its typical `metadata`.*

## 3. IPC Commands (Client to RedEye)

### 3.1. General Commands

#### `logMessageFromServer`
*   **Description:** Instructs RedEye to log a message on behalf of the client. This is primarily for debugging or allowing agents to record information within RedEye's log stream.
*   **Action:** `logMessageFromServer`
*   **Request Payload:**
    ```json
    {
      "message": "Your log message here"
      // "level": "info" // Optional, not currently implemented for different levels
    }
    ```
*   **Response:**
    *   Standard ACK/NACK (e.g., `{"status": "success", "message": "Log message processed."}`)

### 3.2. Configuration Commands

These commands interact with RedEye's `ConfigurationManager`. Changes made via setters are persisted to `~/.redeye/config.json`.

#### `getConfig`
*   **Description:** Retrieves the entire current RedEye application configuration.
*   **Action:** `getConfig`
*   **Request Payload:** None.
*   **Response Data (`data` field on success):** The complete `RedEyeConfig` object. Example structure:
    ```json
    {
      "schemaVersion": "1.0",
      "monitorSettings": {
        "keyboardMonitorManager": { "type": "keyboardMonitorManager", "isEnabled": true, "parameters": null },
        "appActivationMonitor": { "type": "appActivationMonitor", "isEnabled": false, "parameters": {"enableBrowserURLCapture": false} }
        // ... other monitors
      },
      "generalSettings": {
        "showPluginPanelOnHotkeyCapture": false
      }
    }
    ```
    *(Note: `type` field in `MonitorSpecificConfig` in JSON is illustrative, it's derived from the key in `monitorSettings`)*

#### `getMonitorSettings`
*   **Description:** Retrieves the configuration settings for all available monitors.
*   **Action:** `getMonitorSettings`
*   **Request Payload:** None.
*   **Response Data (`data` field on success):** A dictionary where keys are `MonitorType.rawValue` strings and values are `MonitorSpecificConfig` objects.
    ```json
    {
      "keyboardMonitorManager": { "isEnabled": true, "parameters": null },
      "appActivationMonitor": { "isEnabled": false, "parameters": {"enableBrowserURLCapture": false} }
      // ... other monitors
    }
    ```

#### `getMonitorSetting`
*   **Description:** Retrieves the configuration for a single, specified monitor.
*   **Action:** `getMonitorSetting`
*   **Request Payload:**
    ```json
    {
      "monitorType": "nameOfMonitor" // e.g., "keyboardMonitorManager"
    }
    ```
*   **Response Data (`data` field on success):** The `MonitorSpecificConfig` object for the requested monitor, or `null` if not found (though unlikely with current enum-based types).

#### `setMonitorEnabled`
*   **Description:** Enables or disables a specific monitor.
*   **Action:** `setMonitorEnabled`
*   **Request Payload:**
    ```json
    {
      "monitorType": "nameOfMonitor", // e.g., "fsEventMonitorManager"
      "isEnabled": true | false
    }
    ```
*   **Response:** Standard ACK/NACK.

#### `getMonitorParameters`
*   **Description:** Retrieves the specific parameters for a given monitor.
*   **Action:** `getMonitorParameters`
*   **Request Payload:**
    ```json
    {
      "monitorType": "nameOfMonitor" // e.g., "fsEventMonitorManager"
    }
    ```
*   **Response Data (`data` field on success):** The `parameters` object (`[String: JSONValue]`) for the monitor, or `null` if no parameters are set. Example for `fsEventMonitorManager`:
    ```json
    {
      "paths": ["~/Desktop", "/tmp"] 
    } 
    ```
    *(Note: `JSONValue` types like `.string("text")` or `.array([...])` will be represented as standard JSON strings, arrays, etc., in the actual JSON response.)*


#### `setMonitorParameters`
*   **Description:** Sets or updates the parameters for a specific monitor. This replaces all existing parameters for that monitor.
*   **Action:** `setMonitorParameters`
*   **Request Payload:**
    ```json
    {
      "monitorType": "nameOfMonitor", // e.g., "fsEventMonitorManager"
      "parameters": { /* New parameters object, e.g., {"paths": ["~/Documents"]} */ }
    }
    ```
    *   The `parameters` object should conform to the expected structure for that monitor (e.g., `{"paths": ["path1", "path2"]}` for `fsEventMonitorManager`).
*   **Response:** Standard ACK/NACK.

#### `getGeneralSettings`
*   **Description:** Retrieves the general application settings.
*   **Action:** `getGeneralSettings`
*   **Request Payload:** None.
*   **Response Data (`data` field on success):** The `GeneralAppSettings` object.
    ```json
    {
      "showPluginPanelOnHotkeyCapture": false
    }
    ```

#### `setGeneralSettings`
*   **Description:** Updates the general application settings. The provided payload object will replace the existing `generalSettings`.
*   **Action:** `setGeneralSettings`
*   **Request Payload:** The complete `GeneralAppSettings` object.
    ```json
    {
      "showPluginPanelOnHotkeyCapture": true
    }
    ```
*   **Response:** Standard ACK/NACK.

#### `getCapabilities`
*   **Description:** Retrieves information about RedEye's current capabilities, including available monitors, event types, and basic configuration information.
*   **Action:** `getCapabilities`
*   **Request Payload:** None.
*   **Response Data (`data` field on success):** A dictionary detailing capabilities. Example structure:
    ```json
    {
      "appName": "RedEye",
      "configSchemaVersion": "1.0",
      "configFileLocation": "/Users/username/Library/Application Support/RedEye/config.json",
      "availableEventMonitors": [
        { "name": "keyboardMonitorManager", "isEnabledByDefaultInCurrentConfig": true, "configurableParameters": {"exampleDebounceInterval": "Double (seconds, hypothetical example)"} },
        { "name": "fsEventMonitorManager", "isEnabledByDefaultInCurrentConfig": false, "configurableParameters": {"paths": "[String] (e.g., [\"~/Documents\", \"/tmp\"])"} }
        // ... other monitors
      ],
      "availableEventTypes": [
        "textSelection", "applicationActivated", "fileSystemEvent", "keyboardEvent", "browserNavigation"
      ],
      "generalSettingsFields": [
        "showPluginPanelOnHotkeyCapture: Bool"
      ]
    }
    ```

#### `resetConfigToDefaults`
*   **Description:** Resets RedEye's entire configuration to its factory default settings and persists them.
*   **Action:** `resetConfigToDefaults`
*   **Request Payload:** None.
*   **Response:** Standard ACK/NACK.


## 4. Event Types & Payloads (RedEye to Client)

This section details the `eventType` values that can appear in broadcasted `RedEyeEvent` objects and provides information on their typical `metadata` content.

*(This section would be populated based on `RedEyeEventType` enum and the data each monitor provides. Example entries below.)*

### `textSelection`
*   **Description:** Fired when text is selected by the user (either via hotkey or mouse-based shortcut-less selection).
*   **`sourceApplicationName` / `sourceBundleIdentifier`:** The application where the text selection occurred.
*   **`contextText`:** The selected text.
*   **`metadata`:**
    *   `"trigger"`: (String) "hotkey (⌘⇧C)" or "mouse_selection".
    *   `"textCaptureError"`: (String, Optional) Description of an error if text capture failed (e.g., from `TextCaptureService`).

### `applicationActivated`
*   **Description:** Fired when a new application becomes frontmost.
*   **`sourceApplicationName` / `sourceBundleIdentifier`:** The application that was activated.
*   **`contextText`:** None.
*   **`metadata`:**
    *   `"pid"`: (String) Process ID of the activated application.

### `fileSystemEvent`
*   **Description:** Fired when a file system event occurs in a monitored path.
*   **`sourceApplicationName` / `sourceBundleIdentifier`:** Typically `null` as these events are system-wide.
*   **`contextText`:** The path of the item that changed.
*   **`metadata`:** Contains detailed flags about the FS event. Examples:
    *   `"fs_event_id"`: (String) The FSEvent ID.
    *   `"fs_raw_flags"`: (String) Raw hex flags.
    *   `"fs_item_created"`: (String) "true" if applicable.
    *   `"fs_item_removed"`: (String) "true" if applicable.
    *   `"fs_item_modified"`: (String) "true" if applicable.
    *   `"fs_item_type"`: (String) "file", "directory", "symlink".
    *   *(Many other `fs_*` flags as detailed in `FSEventMonitorManager.interpretFSEventFlags`)*.

### `keyboardEvent`
*   **Description:** Fired for global keyboard events (keyDown, keyUp, flagsChanged).
*   **`sourceApplicationName` / `sourceBundleIdentifier`:** Typically `null` as these are global.
*   **`contextText`:** The character produced by the key event, if applicable.
*   **`metadata`:**
    *   `"keyboard_event_type"`: (String) "keyDown", "keyUp", or "flagsChanged".
    *   `"keyboard_key_code"`: (String) The raw key code.
    *   `"keyboard_character"`: (String, Optional) The character representation.
    *   `"keyboard_modifiers_flags"`: (String) Raw CGEventFlags value.
    *   `"keyboard_modifier_cmd_active"`: (String) "true" or "false".
    *   *(Other `keyboard_modifier_*_active` flags for shift, option, control, fn, capslock)*.

### `browserNavigation` (Experimental)
*   **Description:** Fired when Safari is activated and (if enabled & permitted) its current URL and title are captured. This feature is experimental and may be blocked by OS permissions.
*   **`sourceApplicationName` / `sourceBundleIdentifier`:** "Safari" / "com.apple.Safari".
*   **`contextText`:** None (URL and title are in metadata).
*   **`metadata`:**
    *   `"browser_url"`: (String) The URL of the frontmost tab in Safari.
    *   `"browser_page_title"`: (String) The title of the frontmost tab.
    *   `"trigger"`: (String) "appActivated".
    *   `"error"`: (String, Optional) Description of an error if URL/title capture failed (e.g., AppleScript error, permission issue).

## 5. Future Considerations
*   ACK/NACK for more commands.
*   More detailed error codes in responses.
*   Server-side event filtering subscription commands.
*   Commands for interacting with a potential future "Compound Event" rule engine.
